# 週間予定管理アプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
週間予定管理アプリケーション

### 1.2 背景・目的
現在ホワイトボードと紙の「搬入申請依頼書」で行っている週間予定の管理をデジタル化する。チーム全員がPCやスマートフォンから、いつでもどこでも最新の予定を確認・登録・更新できる環境を構築し、業務の効率化と情報共有の円滑化を目指す。

### 1.3 対象ユーザー
- 社内チームメンバー（一般ユーザー・管理者）

## 2. システム要件

### 2.1 技術スタック
- **フロントエンド**: Next.js (App Router)
- **バックエンド**: Supabase (PostgreSQL, Auth, Storage)
- **UI/CSS**: React, Tailwind CSS
- **デプロイ**: Vercel 予定

### 2.2 対応デバイス
- PC（デスクトップ）
- スマートフォン
- レスポンシブデザイン対応

### 2.3 タイムゾーン
- 日本時間（JST）統一

## 3. 機能要件

### 3.1 認証機能
- メールアドレス・パスワードによるログイン
- Supabase Authを使用
- ログアウト機能

### 3.2 ユーザー管理
- **一般ユーザー（role: user）**
  - 自分の予定の登録・更新・削除
  - 全ての予定の閲覧
- **管理者（role: admin）**
  - 全ての予定の登録・更新・削除・閲覧
  - **ユーザー管理機能**
    - 新規ユーザー作成（メールアドレス・パスワード・氏名・役割設定）
    - 既存ユーザーの編集（氏名・役割変更）
    - ユーザー削除
    - ユーザー一覧表示（メールアドレス表示）

### 3.2.1 階層的ユーザー管理システム
- **超級管理者（プロジェクト所有者）**: Supabaseダッシュボードアクセス
- **管理者**: アプリ内でのユーザー管理権限
- **一般ユーザー**: 予定管理のみ
- セキュリティ: オープン登録なし、招待制システム

### 3.3 予定管理機能
#### 3.3.1 予定登録
以下の項目を入力可能：
- 得意先名（必須）
- 開始日時（必須、5分単位で選択）
- 終了日時（任意、5分単位で選択、開始時刻+5分以降）
- 現場名（必須）
- 現場住所（必須）
- 搬入商品・数量（必須）
- 担当者同行の有無（必須）
- 人員の有無・人数・時間（任意）
  - 人数：1-10名選択
  - 時間：4時間または8時間選択（必須）
- 運送区分（必須）：M便、別便、人員のみ
- **運送区分詳細（チェックボックス形式、複数選択可能）**：
  - 引取り（運送会社等）：プリセット運送会社選択（オカケン、福山通運、トナミ運輸、西濃運輸、その他入力可能）+ 支店名
  - 引取り（アスワン広島支店）
  - チャーター（台数：1-10台選択）
- 備考（任意）

#### 3.3.2 予定表示
- 週間カレンダー形式での表示
- PC: 7列の週間レイアウト
- スマートフォン: 1列のリスト形式
- 予定カードに表示する情報（色分けラベル付き表示）：
  - **時間:** [開始 - 終了時間]（青色ラベル）
  - **得意先名:** [会社名]（紫色ラベル）
  - **現場名:** [現場名]（緑色ラベル）
  - **現場住所:** [住所]（琥珀色ラベル）
  - **担当:** [担当者名]（インディゴ色ラベル）
  - **運送区分アイコン**（常時表示）：
    - M便：赤色背景、カレンダーアイコン
    - 別便：黄色背景、上下矢印アイコン
    - 人員のみ：緑色背景、人型アイコン
  - **担当者同行アイコン**（同行ありの場合のみ）：青色背景、人型アイコン
  - **人員アイコン**（人員ありの場合のみ）：緑色背景、人型絵文字 + 人数
  - **引取り場所:**（ローズ色ラベル、設定がある場合のみ表示、優先順位順）
    - 引取り（運送会社等）（オレンジ色ドット）：運送会社名 [支店名がある場合のみ]支店止め
    - 引取り（アスワン広島支店）（青色ドット）
    - チャーター○台（緑色ドット）

#### 3.3.3 予定編集・削除
- 自分が登録した予定の編集・削除（一般ユーザー）
- 全ての予定の編集・削除（管理者）
- モーダルダイアログでの編集画面

### 3.4 通知機能
- **通知方法**: メール通知
- **通知タイミング**: リアルタイム
- **通知対象**: チーム全員
- **通知イベント**:
  - 新規予定追加時
  - 予定変更時
  - 予定削除時

### 3.5 カレンダー操作
- 週の移動（前週・次週ボタン）
- 当日へのジャンプ機能

## 4. データベース設計

### 4.1 users テーブル（担当者）
| カラム名 | データ型 | 制約 | 説明 |
|---------|----------|------|------|
| id | UUID | PRIMARY KEY, FK | Supabase AuthのユーザーIDと連携（auth.users.idへの外部キー） |
| full_name | VARCHAR(255) | NOT NULL | 担当者の氏名 |
| email | VARCHAR(255) | NULL | メールアドレス（表示用、auth.usersと同期） |
| role | VARCHAR(50) | NOT NULL | ユーザーの役割（'admin' または 'user'） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新日時 |

### 4.2 tasks テーブル（予定）
| カラム名 | データ型 | 制約 | 説明 |
|---------|----------|------|------|
| id | INTEGER | PRIMARY KEY | 自動採番 |
| user_id | UUID | NOT NULL, FK | 登録者ID（users.id） |
| customer_name | VARCHAR(255) | NOT NULL | 得意先名 |
| start_datetime | TIMESTAMPTZ | NOT NULL | 開始日時 |
| end_datetime | TIMESTAMPTZ | NULL | 終了日時 |
| site_name | VARCHAR(255) | NOT NULL | 現場名 |
| site_address | TEXT | NOT NULL | 現場住所 |
| goods_description | TEXT | NOT NULL | 搬入商品・数量 |
| is_staff_accompanied | BOOLEAN | NOT NULL | 担当者同行の有無 |
| has_part_timer | BOOLEAN | DEFAULT FALSE | 人員の有無 |
| part_timer_count | INTEGER | NULL | 人員の人数（1-10名） |
| part_timer_duration | VARCHAR(50) | NULL | 人員の時間（4hまたは8h） |
| transport_method | VARCHAR(50) | NOT NULL | 運送区分（M便、別便、人員のみ） |
| transport_categories | JSONB | NULL | 運送区分詳細（JSON形式） |
| remarks | TEXT | NULL | 備考 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |

### 4.2.1 transport_categories フィールド詳細
運送区分の詳細情報をJSON形式で格納：
```json
{
  "aswan": boolean,              // 引取り（アスワン広島支店）の有無
  "charter": boolean,            // チャーターの有無
  "charterCount": number,        // チャーターの台数（1-10台）
  "shippingCompany": boolean,    // 引取り（運送会社等）の有無
  "selectedCompany": string,     // 選択された運送会社名
  "customCompany": string,       // その他の場合の引取り場所名
  "branchName": string          // 支店名（空白の場合は支店止め表示なし）
}
```

## 5. セキュリティ要件

### 5.1 認証・認可
- Supabase Authによる認証
- Row Level Security (RLS) によるデータアクセス制御

### 5.2 データアクセス制御
- **一般ユーザー**: 自分の予定のみ編集・削除可能、全予定閲覧可能
- **管理者**: 全ての操作が可能

## 6. UI/UX要件

### 6.1 デザインコンセプト
- クリーン＆シンプル
- 見やすさと分かりやすさを最優先

### 6.2 配色
- 白を基調
- メインカラー: 青系
- アクセントカラー: 予定の種類による色分け
  - M便: 赤系（エムワーク便）
  - 別便: 黄系（チャーター便等）
  - 人員のみ: 緑系（人員派遣のみ）
  - 通常: グレー系（通常の予定）
- **ラベル色分けシステム**:
  - 時間: blue-600
  - 得意先名: purple-600
  - 現場名: emerald-600
  - 現場住所: amber-600
  - 担当: indigo-600
  - 引取り場所: rose-600

### 6.3 レスポンシブデザイン
- PC・スマートフォン両対応
- Tailwind CSSを使用

### 6.4 UI/UX限界突破実装【v1.6追加】
#### 6.4.1 グラスモーフィズム効果
- **背景**: グラデーション背景（紫-青グラデーション）
- **ガラス効果**: 半透明背景 + ブラー効果（backdrop-filter: blur(10px)）
- **適用箇所**: ヘッダー、カレンダーヘッダー、予定カード、ドロップダウンメニュー
- **コントラスト対応**: `bg-white bg-opacity-90-95`で高い視認性を確保

#### 6.4.2 マイクロインタラクション
- **ホバーエフェクト**: 浮上効果（`hover-lift`）、スケール効果（`btn-hover-scale`）
- **アニメーション**: 
  - 登場: `animate-fade-in-up`, `animate-fade-in-down`, `animate-scale-in`
  - 浮遊: `animate-float`（ロゴ・アイコン用）
  - パルスグロー: `animate-pulse-glow`（通知バッジ・強調用）
- **トランジション**: `transition-all-smooth`（0.3s ease-in-out）

#### 6.4.3 グラデーション&シャドウシステム
- **グラデーション**:
  - プライマリ: `gradient-primary`（青系）
  - 危険: `gradient-danger`（赤系）
  - 警告: `gradient-warning`（黄系）
  - 成功: `gradient-success`（緑系）
  - 背景: `gradient-bg`（紫-青グラデーション）
- **シャドウ**:
  - エレガント: `shadow-elegant`（標準）
  - フローティング: `shadow-floating`（浮遊効果用）

#### 6.4.4 z-index階層管理
- 背景: z-0
- ヘッダー: z-10
- ドロップダウン親要素: z-50
- ドロップダウンメニュー: z-9999
- モバイルオーバーレイ: z-90

## 7. 画面構成

### 7.1 ログイン画面（/login）
- アプリロゴ
- メールアドレス・パスワード入力欄
- ログインボタン

### 7.2 メイン画面（/main）
- ヘッダー（週移動ボタン、新規予定追加ボタン、管理者メニュー、ユーザーメニュー）
- 週間カレンダー表示
- 予定カード
- **管理者限定**: ユーザー管理ボタン

### 7.3 ユーザー管理画面（/users）【管理者限定】
- ユーザー一覧テーブル（氏名・メールアドレス・役割・登録日・操作）
- 新規ユーザー作成ボタン
- **新規ユーザー作成モーダル**
  - メールアドレス入力
  - パスワード入力
  - 氏名入力
  - 役割選択（管理者・一般ユーザー）
- **ユーザー編集モーダル**
  - 氏名編集
  - 役割変更
- ユーザー削除機能（確認ダイアログ付き）

### 7.4 予定登録・編集フォーム
- 新規登録: 専用ページ（/tasks/new）
- 編集: モーダルダイアログ
- 全項目入力フォーム
- 保存・削除ボタン

## 8. 非機能要件

### 8.1 不要な機能（明確に除外）
- データ検索・フィルタリング機能
- 既存データの移行機能
- 印刷機能
- 月表示・日表示への切り替え
- 外部ユーザー（お客様等）のアクセス機能
- 特別なバックアップ・復旧機能

### 8.2 パフォーマンス
- レスポンス時間: 3秒以内
- 同時接続ユーザー数: 20名程度想定

### 8.3 可用性
- Supabase・Vercelのサービス可用性に依存

## 9. 開発・運用

### 9.1 開発フェーズ
1. **プロジェクト初期化・環境設定**
   - Next.jsプロジェクト作成
   - Tailwind CSS導入・設定
   - 基本ディレクトリ構造の作成
   - Git初期化

2. **UI/UX実装（モックアップ・デザインシステム構築）**
   - デザインシステム（色、フォント、コンポーネント）定義
   - ログイン画面のモックアップ・実装
   - メイン画面（週間カレンダー）のモックアップ・実装
   - 予定カードコンポーネントの実装
   - 予定登録・編集フォームのモックアップ・実装
   - レスポンシブデザインの調整

3. **データベース・認証システム構築**
   - Supabaseプロジェクト作成
   - データベーステーブル設計・作成（users, tasks）
   - Row Level Security（RLS）ポリシー設定
   - Supabase Auth設定
   - 認証機能実装（ログイン・ログアウト）

4. **基本CRUD機能実装**
   - 予定一覧表示機能
   - 予定登録機能
   - 予定編集機能
   - 予定削除機能
   - ユーザー権限制御実装

4.5. **ユーザー管理システム実装**【完了】
   - 階層的ユーザー管理システム設計・実装
   - 管理者用ユーザー管理画面（/users）
   - 新規ユーザー作成機能（Supabase Auth Admin API連携）
   - ユーザー編集・削除機能
   - Service Role キー設定とセキュリティ強化
   - メールアドレス表示とローマ字化対応

5. **通知機能実装**
   - メール通知システムの設計
   - 予定変更時の通知トリガー実装
   - 通知テンプレート作成

6. **テスト・デバッグ**
   - 機能テスト
   - レスポンシブデザインテスト
   - 権限制御テスト
   - 通知機能テスト

7. **デプロイ・運用開始**
   - Vercelにデプロイ設定
   - 本番環境テスト
   - ユーザートレーニング・引き継ぎ

### 9.2 保守・運用
- 基本的なSupabase・Vercelの管理画面での運用
- 特別な監視・バックアップシステムは導入しない

---

**作成日**: 2025年8月11日  
**最終更新**: 2025年8月17日  
**バージョン**: 1.6

## 更新履歴
- **v1.6** (2025年8月17日): UI/UX限界突破実装
  - グラスモーフィズム効果の全面導入（ヘッダー・カレンダー・カード・ドロップダウン）
  - マイクロインタラクション強化（ホバー・浮遊・パルスグロー・スケールアニメーション）
  - 未来感のあるグラデーション背景とシャドウシステム
  - 視認性改善（高コントラストテキスト・適切な背景透明度調整）
  - 予定カードレイアウト改善（2行構造・運送区分ラベル独立表示）
  - ドロップダウンメニューz-index問題解決（階層管理システム導入）
  - レスポンシブ強化（スマホ通知ドロップダウン表示最適化）
  - UX改善（外側クリック機能・×ボタン配置最適化）
  - animations.css新規作成とアニメーションライブラリ構築
- **v1.5** (2025年8月17日): 階層的ユーザー管理システム実装
  - 管理者用ユーザー管理機能追加（新規作成・編集・削除・一覧表示）
  - Supabase Auth Admin API連携による安全なユーザー作成
  - usersテーブルにemailカラム追加、外部キー制約対応
  - 階層的権限システム（超級管理者・管理者・一般ユーザー）
  - オープン登録なしの招待制システム実装
  - メールアドレスローマ字化対応
  - Service Role キー設定とセキュリティ強化
- **v1.4** (2025年8月15日): UI/UX改善と仕様調整
  - 運送区分表示順序変更：引取り（運送会社等）→引取り（アスワン広島支店）→チャーター
  - 運送区分アイコン表示改善（M便・別便・人員のみのアイコンを常時表示）
  - 時間選択を5分単位に変更
  - 「その他」選択時のラベルを「その他引取り場所」に変更
  - 支店名が空白の場合の表示改善（「支店止め」を非表示）
  - 「アルバイト」を「人員」に用語統一
  - 人員選択時の自動制御追加（人員のみ選択時に人員チェックボックス自動ON）
  - 人数選択を1名からに変更
  - 時間制約追加（終了時間は開始時間+5分以降）
- **v1.3** (2025年8月15日): 予定カード視認性向上
  - 各項目ラベルの色分け実装（時間・得意先名・現場名・現場住所・担当・引取り場所）
  - 視認性向上のためのカラーシステム導入
- **v1.2** (2025年8月15日): 予定カード表示の改善
  - 予定カード表示項目にラベル付き表示を導入
  - 現場住所を新規表示項目として追加
  - 運送区分を「引取り場所」に名称変更し、表示条件を明確化
- **v1.1** (2025年8月15日): 運送区分機能追加
  - tasksテーブルにtransport_categories（JSONB）フィールド追加
  - 新規運送区分の詳細仕様（アスワン広島支店止め、チャーター、運送会社選択）
  - 予定登録・表示機能の拡張
- **v1.0** (2025年8月11日): 初版作成